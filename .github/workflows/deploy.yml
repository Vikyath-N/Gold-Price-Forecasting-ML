name: 🌐 Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 🚀 Checkout
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: 📦 Create Required Directories
        run: |
          echo "🔍 Creating required directories..."
          mkdir -p docs/data
          mkdir -p docs/assets/css
          mkdir -p docs/assets/js
          
          # Create sample data files if they don't exist
          if [ ! -f "docs/data/web_data.json" ]; then
            echo "📊 Creating sample web data..."
            cp docs/data/sample_data.json docs/data/web_data.json
            echo "✅ Sample web data created successfully!"
          fi
          
          if [ ! -f "docs/data/latest_forecast.json" ]; then
            echo "🔮 Creating sample forecast data..."
            cp docs/data/sample_data.json docs/data/latest_forecast.json
            echo "✅ Sample forecast data created successfully!"
          fi
          
          echo "✅ Data preparation completed!"

      - name: 🔧 Optimize Assets
        run: |
          echo "⚡ Optimizing web assets..."
          
          # Create robots.txt
          echo "User-agent: *" > docs/robots.txt
          echo "Allow: /" >> docs/robots.txt
          echo "" >> docs/robots.txt
          echo "Sitemap: https://$(echo $GITHUB_REPOSITORY | cut -d'/' -f1).github.io/$(echo $GITHUB_REPOSITORY | cut -d'/' -f2)/sitemap.xml" >> docs/robots.txt
          
          # Create sitemap.xml
          echo '<?xml version="1.0" encoding="UTF-8"?>' > docs/sitemap.xml
          echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' >> docs/sitemap.xml
          echo '  <url>' >> docs/sitemap.xml
          echo '    <loc>https://$(echo $GITHUB_REPOSITORY | cut -d"/" -f1).github.io/$(echo $GITHUB_REPOSITORY | cut -d"/" -f2)/</loc>' >> docs/sitemap.xml
          echo '    <lastmod>$(date +%Y-%m-%d)</lastmod>' >> docs/sitemap.xml
          echo '    <changefreq>daily</changefreq>' >> docs/sitemap.xml
          echo '    <priority>1.0</priority>' >> docs/sitemap.xml
          echo '  </url>' >> docs/sitemap.xml
          echo '</urlset>' >> docs/sitemap.xml
          
          # Create manifest.json for PWA
          echo '{' > docs/manifest.json
          echo '  "name": "Gold Price Forecasting AI",' >> docs/manifest.json
          echo '  "short_name": "Gold AI",' >> docs/manifest.json
          echo '  "description": "Real-time ML-powered gold price predictions",' >> docs/manifest.json
          echo '  "start_url": "/",' >> docs/manifest.json
          echo '  "display": "standalone",' >> docs/manifest.json
          echo '  "background_color": "#0F1419",' >> docs/manifest.json
          echo '  "theme_color": "#FFD700",' >> docs/manifest.json
          echo '  "icons": [' >> docs/manifest.json
          echo '    {' >> docs/manifest.json
          echo '      "src": "data:image/svg+xml,<svg xmlns=\u0027http://www.w3.org/2000/svg\u0027 viewBox=\u00270 0 100 100\u0027><circle cx=\u002750\u0027 cy=\u002750\u0027 r=\u002740\u0027 fill=\u0027%23FFD700\u0027/><text x=\u002750\u0027 y=\u002760\u0027 text-anchor=\u0027middle\u0027 font-size=\u002730\u0027 fill=\u0027%23000\u0027>🥇</text></svg>",' >> docs/manifest.json
          echo '      "sizes": "192x192",' >> docs/manifest.json
          echo '      "type": "image/svg+xml"' >> docs/manifest.json
          echo '    }' >> docs/manifest.json
          echo '  ]' >> docs/manifest.json
          echo '}' >> docs/manifest.json
          
          echo "✅ Asset optimization completed!"

      - name: 📊 Validate Data Files
        run: |
          echo "🔍 Validating data files..."
          
          # Check if required files exist
          required_files=("docs/index.html" "docs/assets/css/style.css" "docs/assets/js/app.js" "docs/data/web_data.json")
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "✅ $file exists"
            else
              echo "❌ $file is missing"
              exit 1
            fi
          done
          
          # Validate JSON files
          echo "🔍 Validating JSON data..."
          for file in docs/data/web_data.json docs/data/latest_forecast.json docs/data/sample_data.json; do
            if [ -f "$file" ]; then
              if python3 -m json.tool "$file" > /dev/null 2>&1; then
                echo "✅ $file is valid JSON"
              else
                echo "❌ $file has invalid JSON"
                exit 1
              fi
            else
              echo "⚠️  $file not found"
            fi
          done
          
          echo "✅ Data validation completed!"

      - name: 🏗️ Setup Pages
        uses: actions/configure-pages@v4
        
      - name: 📤 Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: 🌐 Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: 🎉 Deployment Summary
        run: |
          echo "## 🌐 Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🔗 **Live URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "📅 **Deployed**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "🚀 **Status**: Active" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Features Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Interactive gold price dashboard" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Real-time ML predictions" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Multi-model comparison" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Historical price charts" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Mobile-responsive design" >> $GITHUB_STEP_SUMMARY
